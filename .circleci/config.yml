version: 2.1

parameters:
  build-image:
    type: string
    default: "circleci/node:14.5.0"


jobs:
  lint-backend:
    docker:
      - image: << pipeline.parameters.build-image >>
    steps:
      - checkout
      - run:
          name: Install
          command: |
            cd backend
            npm install
      - run:
          name: Lint
          command: |
            cd backend
            npm run build
            ls

  test-backend:
    docker:
      - image: << pipeline.parameters.build-image >>
    steps:
      - checkout
      - run:
          name: Install
          command: |
            cd backend
            npm install
      - run:
          name: Test
          command: |
            cd backend
            npm run test

  analyze-backend:
    docker:
      - image: << pipeline.parameters.build-image >>
    steps:
      - checkout
      - run:
          name: Install
          command: |
            cd backend
            npm install
      - run:
          name: Analyze
          command: |
            cd backend
            npm audit --audit-level=critical

  lint-frontend:
    docker:
      - image: << pipeline.parameters.build-image >>
    steps:
      - checkout
      - run:
          name: Install
          command: |
            cd frontend
            npm install
      - run:
          name: Lint
          command: |
            cd frontend
            npm run build

  test-frontend:
    docker:
      - image: << pipeline.parameters.build-image >>
    steps:
      - checkout
      - run:
          name: Install
          command: |
            cd frontend
            npm install
      - run:
          name: Test
          command: |
            cd frontend
            npm run test

  analyze-frontend:
    docker:
      - image: << pipeline.parameters.build-image >>
    steps:
      - checkout
      - run:
          name: Install
          command: |
            cd frontend
            npm install
      - run:
          name: Analyze
          command: |
            cd frontend
            npm audit --audit-level=critical


workflows:
  backend:
    jobs:
      - lint-backend
      - test-backend:
          requires:
            - lint-backend
      - analyze-backend:
          requires:
            - test-backend

  frontend:
    jobs:
      - lint-frontend
      - test-frontend:
          requires:
            - lint-frontend
      - analyze-frontend:
          requires:
            - test-frontend
